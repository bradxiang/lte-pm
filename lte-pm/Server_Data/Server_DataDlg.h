// Server_DataDlg.h : 头文件
#pragma once
//程序框架提供
#include "resource.h"													// 主符号
#include "afxcmn.h"
#include <afxmt.h> 
#include "afxwin.h"
#include "MySplitter.h"													//分窗
#include "afxwin.h"
#include "afxdtctl.h"
#include "AlarmNotify.h"
#include "TelnetManager.h"												//Telnet管理 【初始化、发送、接收、关闭】
#include "Sys_PARM.h"
//GZ文件解压
#include "../../DecompressLibrary/DecompressClass.h"
//性能计算
#include "MyFormula.h"
//性能预警
#include "PerformanceWarning.h"
//过滤
#include "MyFilter.h"
//基本性能小区处理
#include "BasePmProcessing.h"
//计算性能小区处理
#include "CalculationPmProcessing.h"
//区域性能处理
#include "RegionPmProcessing.h"
//数据库维护表
#include "DBMaintenance.h"
//补录文件
#include "FileCollection.h"
// CServer_DataDlg 对话框
class CServer_DataDlg : public CDialog
{
// 构造
public:
	CServer_DataDlg(CWnd* pParent = NULL);								// 标准构造函数
	virtual ~CServer_DataDlg();											// 析构函数
// 对话框数据
	enum { IDD = IDD_SERVER_DATA_DIALOG };
	protected:
	virtual void DoDataExchange(CDataExchange* pDX);					// DDX/DDV 支持
// 实现
protected:
	HICON m_hIcon;
	// 生成的消息映射函数
	virtual BOOL OnInitDialog();
	afx_msg void OnPaint();
	afx_msg HCURSOR OnQueryDragIcon();
	DECLARE_MESSAGE_MAP()
public:
	//------------------------------------------------------------------------------------------------------
	//消息响应函数	
	//------------------------------------------------------------------------------------------------------
	afx_msg void OnBnClickedOk();
	afx_msg void OnBnClickedOutput2();
	afx_msg void OnBnClickedButton1();
	afx_msg void OnClose();
	afx_msg void OnSize(UINT nType, int cx, int cy);
	afx_msg void OnTimer(UINT_PTR nIDEvent);
	afx_msg void OnBnClickedOk2();
	afx_msg void OnBnClickedFile2();
	afx_msg void OnBnClickedFile3();
	afx_msg void OnBnClickedSystemParm();

	//------------------------------------------------------------------------------------------------------
	//	分窗
	//------------------------------------------------------------------------------------------------------
	CSSplitter		m_SplitterPane_Main;								//水平线
	CSSplitter		m_SplitterPane_Left;								//垂直线：左右
	CSSplitter		m_SplitterPane_Right;								//垂直线：左右

	//------------------------------------------------------------------------------------------------------
	//	控件变量
	//------------------------------------------------------------------------------------------------------
	CMyListCtrl		m_cList_Command;									//ListCtrl：指令信息
	CMyListCtrl		m_cList_Client;										//ListCtrl：客户端指令信息
	CMyListCtrl		m_cList_Bug;										//ListCtrl：异常
	CMyListCtrl		m_cList_Log;										//ListCtrl：客户端Log
	CButton			m_cStart;											//开始采集
	CButton			m_cStop;											//结束采集
	CStatic			m_cState;											//工作进程：【任务数量--报文数量--更新告警数量】
	CButton			m_cLog;												//日志选项
	CStatic			m_cPort;											//
	CButton			m_cServer;											//采集有效
	CStatic         m_cFileCount;                                       //待处理文件数
	CStatic         m_cGTime;                                           //处理粒度时间
	CButton         m_cinformation_monitor;                             //信息监控                                  
	CSys_PARM       PARMDialog;
	CStatic         m_cTest;
	CStatic         m_cTest_File;

	//------------------------------------------------------------------------------------------------------
	//	主要线程相关变量
	//------------------------------------------------------------------------------------------------------
	//报文信息
	list<v_sCommand>	v_lCommand;										//接收信息【指令信息】
	list<v_sCommand>	v_lConnect;										//接收信息【连接信息】
	CCriticalSection	v_cLock_Command;								//同步锁：接收信息
	CCriticalSection	v_cLock_Connect;								//同步锁：连接信息
	CCriticalSection	v_cLock_Send;									//同步锁：发送数据	
	CCriticalSection	v_cProThreadMarkLock;							//同步锁：处理线程标记
	bool				v_bCommamd;										//标志：指令超时[定时置位，统计复位]
	bool				v_bClient;										//标志：客户端处理[定时置位，统计复位]
	bool				v_bTj;											//标志：评估统计[定时置位，统计复位]
	int					v_iProThreadMark;								//处理线程标记 【处理线程复位，1分钟线程判断是否复位，如果有问题，就不能复位】
	//Telnet管理对象
	CTelnetManager	TelnetManager;									    
	//异常通知客户端类
	CAlarmNotify	m_AlarmNotify;																			
	//屏幕最大化标记[初始显示最大化对话窗]
	bool			v_bDlg_Max;											
	//定时中检查key是否有效
	BOOL			m_bKeyTD;											
	//采集端SOCKET
	SOCKET			v_sServer_Socket;									
	//采集端计数器
	int				v_iServer_Sum;										
	//评估保存时间
	COleDateTime	v_tDate_PG;											
	//客户端SOCKET【发送指令的客户端】
	SOCKET			v_iClient_Socket;									
	//指令发送标记
	bool			v_bCommand_Flag;									
	//指令执行计算器【执行超过一定时间，消除指令发送标记】
	int				v_iCommand_Sum;										
	//接收的指令内容
	CString			v_sCommand_Rece;									
	//指令接收时间
	COleDateTime	v_tDate;											
	CStatic m_cAAA;

	//------------------------------------------------------------------------------------------------------
	//基础框架模板	
	//------------------------------------------------------------------------------------------------------
	BOOL		AddCheckBits(u_char* sendData);							                                //增加校验函数
	void		My_Client_Proc();																		//客户端信息处理[超时退出]
    void		My_ShowList_Command_Text(CString v_sText);												//指令执行结果显示
	void		My_ShowList_Log(CString v_sType,CString v_sAlarm);										//日志显示
	void		My_ShowList_Bug(CString v_sBug_Type,CString v_sBug);									//Bug显示	
	void		My_Send_Client_Alarm(unsigned int v_iCode ,CString v_sError);		                    //向所有客户端发送消息
	int			Send_Socket(SOCKET v_sClient_Socket,char* v_sSend,int v_iLen);					        //发送数据
	void		My_ShowList_Client(CString v_sIP,SOCKET v_iSocket,CString v_sName);						//Client显示
	void		Send_Command(SOCKET v_sClient_Socket,unsigned int v_iCode ,CString v_sCommand);	        //发送指令
	void		My_ShowList_Command(CString v_sIP,CString v_sName,CString v_sBSC,CString v_sCommand);	//指令显示
	void        ShowListCommand(CString sFileName,CString sMsg);                                        //显示文件处理信息
	void        ShowListLog(CString sPanTime,CString sFileName,CString sMsg);                           //显示详细文件处理信息

	//------------------------------------------------------------------------------------------------------
	//程序主要线程
	//------------------------------------------------------------------------------------------------------
	int			v_iThread_Exit;											 //线程状态：　0：初始；1：运行	2：强制退出；
	//资源释放同步 
	HANDLE			v_cMutex[14] ;	
	CWinThread* v_pThread_Query;										 //句柄
	//线程：启动主工作任务
	static UINT My_Thread_Read(LPVOID lparam);							
	CWinThread* v_pThread_Command;										 //句柄
	//线程：指令处理线程
	static UINT My_Command(LPVOID lparam);								
	CWinThread* v_pThread_Connect;										 //句柄
	//线程：信息处理线程
	static UINT My_Connect(LPVOID lparam);								
	CWinThread* v_pThread_ParseDataFile;								 //句柄
	//线程：文件解析线程
	static UINT ParseDataFileThread(LPVOID lparam);					    
	CWinThread* v_pThread_MaintainDataBase;								 //句柄
	//线程：数据库维护线程	
	static UINT MaintainDataBaseThread(LPVOID lparam);		
	CWinThread* v_pThread_ExecuteBulkInsert;						     //句柄
	//线程：SQLBulkInsert维护线程	
	static UINT ExecuteBulkInsertThread(LPVOID lparam);
	CWinThread* Thread_SumWholeNetworkPm_;							    //句柄
	//线程：全网性能求和线程
	static UINT SumWholeNetworkPmThread(LPVOID lparam);					
	CWinThread* Thread_SumHWPm_;									    //句柄
	//线程：华为性能求和线程
	static UINT SumHWPmThread(LPVOID lparam);				
	CWinThread* Thread_SumZTEPm_;									    //句柄
	//线程：中兴性能求和线程
	static UINT SumZTEPmThread(LPVOID lparam);				
	CWinThread* Thread_SumRegionandOtherPm_;							//句柄
	//线程：区域和其他性能求和线程
	static UINT SumRegionPmThread(LPVOID lparam);
	CWinThread* Thread1_BaseCellPm_;								    //句柄
	//线程：基本小区性能线程1
	static UINT BaseCellPmThread1(LPVOID lparam);	
	CWinThread* Thread1_CalculateCellPm_;								//句柄
	//线程：小区公式性能线程1
	static UINT CalculateCellPmThread1(LPVOID lparam);		
	CWinThread* Thread_HourBaseCellPm_;								    //句柄
	//线程：基本小区性能线程【小时粒度】
	static UINT HourBaseCellPmThread(LPVOID lparam);	
	CWinThread* Thread_HourCalculateCellPm_;							//句柄
	//线程：小区公式性能线程【小时粒度】
	static UINT HourCalculateCellPmThread(LPVOID lparam);		
	CWinThread* Thread2_BaseCellPm_;								    //句柄
	//线程：基本小区性能线程2
	static UINT BaseCellPmThread2(LPVOID lparam);	

	//------------------------------------------------------------------------------------------------------
	//	控制变量
	//------------------------------------------------------------------------------------------------------
	bool global_control_;
	//控制变量加锁
	CCriticalSection      global_control_lock_;
	//------------------------------------------------------------------------------------------------------
	//	解压文件及XML数据实例
	//------------------------------------------------------------------------------------------------------
	//XML文件解读实例
	CMyFile_XML	          v_cFile_XML;		
	//gz解压实例
	CFile			      v_fWriter;	
	//小区映射【key:小区名称；value:唯一识别码】
	map_Counter           cellname_map_ID_;
	//文件队列锁
	CCriticalSection      v_cLock_FileName;  
	//未处理文件队列
	queue<CString>        file_queue_; 

	//sql栈加锁
	CCriticalSection      sql_lock_;  
	//sql栈
	stack<CString>        sql_stack_;

	//基本性能队列加锁
	CCriticalSection      basePm_lock_;
	//基本性能队列
	list<map_ObjType>     basePm_queue_; 

	//计算性能队列加锁
	CCriticalSection      calculatePm_lock_;
	//计算性能队列
	list<map_ObjType>     calculatePm_queue_; 

	//全网性能队列加锁
	CCriticalSection      networkPm_lock_;
	//全网性能队列
	list<map_ObjType>     networkPm_queue_;

	//华为性能队列加锁
	CCriticalSection      hwPm_lock_;
	//华为性能队列
	list<map_ObjType>     hwPm_queue_;

	//中兴性能队列加锁
	CCriticalSection      ztePm_lock_;
	//中兴性能队列
	list<map_ObjType>     ztePm_queue_;

	//区域性能队列加锁
	CCriticalSection      regionPm_lock_;
	//区域性能队列
	list<map_ObjType>     regionPm_queue_;

	//小时粒度基本性能队列加锁
	CCriticalSection      hour_basePm_lock_;
	//小时粒度基本性能队列
	list<map_ObjType>     hour_basePm_queue_; 

	//小时粒度计算性能队列加锁
	CCriticalSection      hour_calculatePm_lock_;
	//小时粒度计算性能队列
	list<map_ObjType>     hour_calculatePm_queue_; 

	//------------------------------------------------------------------------------------------------------
	//	基础功能函数
	//------------------------------------------------------------------------------------------------------                        
	//数据初始化
	void Init();
	//数据初始化
	void Updata();
	//获得文件时间
	void GetFileTime(const CString& szFileName,CString &sFileTime);
	//执行bulk insert栈
	void ExecuteBulkInsertStack();
	//执行SQL命令
	bool ExecuteSQL(CString v_sSql);							                                    
	//解压GZ文件
	BOOL PMArchive(CString szFileName,CString sFileName); 
	//获得小区其对应的唯一编码
	void GetCellMap(map<CString,CString> &cellname_map_ID);
	//小区名称映射为整数
	void MapCellNameToID(map_ObjType &v_mObjType,map_Counter &cellname_map_ID);
	//获得文件信息
	void GetFileInformation(CString socket_file_name,CString &zip_file_name,CString &zip_file_path,CString &xml_file_name,CString &xml_file_path,CString &file_name,CString &file_time,CString &file_type);
	//接口变量清零
	void ResetObjType(map_ObjType &ObjType);
	//计时
	void KeepTime(CString key,CString message,COleDateTime &before_time);
	//删除重复粒度数据
	void DeleteNextGranularityData(CString granlarity);	

	//------------------------------------------------------------------------------------------------------
	//类实例
	//------------------------------------------------------------------------------------------------------
	//文件补录
	FileCollection  file_collection_;
	//过滤非大连小区类
	CMyFilter       cell_filter_;
	//全网性能过滤
	CMyFilter       network_filter_;
	//全网性能过滤
	CMyFilter       region_filter_;
	//华为性能过滤
	CMyFilter       hw_filter_;
	//中兴性能过滤
	CMyFilter       zte_filter_;
	//处理基本性能
	BasePmProcessing base_Pm_[2]; 
	//计算性能
	CalculationPmProcessing calculation_Pm_[1];
	//全网性能
	RegionPmProcessing network_Pm_;
	//华为性能
	RegionPmProcessing hw_Pm_;
	//中兴性能
	RegionPmProcessing zte_Pm_;
	//区域性能
	RegionPmProcessing region_Pm_;
	//小时粒度处理基本性能
	BasePmProcessing hour_base_Pm_; 
	//小时粒度计算性能
	CalculationPmProcessing hour_calculation_Pm_;
	//数据库维护加锁
	CCriticalSection      DB_maintenance_lock_;
	//数据库维护类
	DBMaintenance DB_maintenance_;
}; 
//------------------------------------------------------------------------------------------------------
//	End
//------------------------------------------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    